<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CST: ProRAW to Blackmagic</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (JSX変換用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* カスタムスクロールバーなどの微調整 */
        body { background-color: #030712; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- アイコンコンポーネント (Lucideの代わり) ---
        const IconUpload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        );
        const IconDownload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        );
        const IconActivity = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        );
        const IconInfo = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        );
        const IconRefresh = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const IconAlert = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const IconFileWarning = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 13v4"/><path d="M12 17h.01"/></svg>
        );

        // --- メインアプリ ---
        const App = () => {
            const [imageSrc, setImageSrc] = useState(null);
            const [processedImageSrc, setProcessedImageSrc] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [error, setError] = useState(null);
            const [fileInfo, setFileInfo] = useState(null);
            const [resolution, setResolution] = useState({ width: 0, height: 0 });
            const hiddenCanvasRef = useRef(null);

            // Constants for Blackmagic Gen 5 Simulation
            const MAT_REC709_TO_BMD_WG = [
                [0.722384, 0.165184, 0.112432],
                [0.021028, 0.932909, 0.046063],
                [0.007606, 0.028682, 0.963712]
            ];

            const clamp = (val) => Math.max(0, Math.min(1, val));

            const toLinear = (c) => {
                return c <= 0.04045 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
            };

            const linToLogBMD = (x) => {
                const a = 0.0869315;
                const b = 0.0;
                const c = 0.618625;
                const d = 0.490713;
                const e = 0.006933;
                const f = 0.0042;

                if (x < e) {
                    return (x * 4.0) + f;
                }
                return (c * Math.log10(x + a) + d);
            };

            const applyMatrix = (r, g, b, matrix) => {
                const newR = r * matrix[0][0] + g * matrix[0][1] + b * matrix[0][2];
                const newG = r * matrix[1][0] + g * matrix[1][1] + b * matrix[1][2];
                const newB = r * matrix[2][0] + g * matrix[2][1] + b * matrix[2][2];
                return [newR, newG, newB];
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setError(null);
                setFileInfo({ name: file.name, type: file.type, size: (file.size / 1024 / 1024).toFixed(2) + ' MB' });

                if (file.type === 'image/tiff' || file.name.toLowerCase().endsWith('.tif') || file.name.toLowerCase().endsWith('.tiff')) {
                    setError("注意: 多くのブラウザはTIFF形式を表示・処理できません。処理が開始されない場合、PNG(ロスレス)に変換して再度お試しください。");
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        setImageSrc(img.src);
                        setProcessedImageSrc(null);
                        setResolution({ width: img.width, height: img.height });
                        setError(null);
                    };
                    img.onerror = () => {
                        setError(`エラー: 画像を読み込めませんでした。フォーマット(${file.type || '不明'})に対応していない可能性があります。`);
                        setImageSrc(null);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const processImage = async () => {
                if (!imageSrc) return;
                setIsProcessing(true);

                setTimeout(() => {
                    try {
                        const canvas = hiddenCanvasRef.current;
                        const ctx = canvas.getContext('2d', { colorSpace: 'srgb' });
                        const img = new Image();
                        
                        img.onload = () => {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;

                            for (let i = 0; i < data.length; i += 4) {
                                let r = data[i] / 255.0;
                                let g = data[i + 1] / 255.0;
                                let b = data[i + 2] / 255.0;

                                r = toLinear(r);
                                g = toLinear(g);
                                b = toLinear(b);

                                const [lr, lg, lb] = applyMatrix(r, g, b, MAT_REC709_TO_BMD_WG);

                                const logR = linToLogBMD(Math.max(0, lr));
                                const logG = linToLogBMD(Math.max(0, lg));
                                const logB = linToLogBMD(Math.max(0, lb));

                                data[i] = clamp(logR) * 255;
                                data[i + 1] = clamp(logG) * 255;
                                data[i + 2] = clamp(logB) * 255;
                            }

                            ctx.putImageData(imageData, 0, 0);
                            setProcessedImageSrc(canvas.toDataURL('image/png'));
                            setIsProcessing(false);
                        };
                        img.src = imageSrc;
                    } catch (err) {
                        setError("処理中にエラーが発生しました: " + err.message);
                        setIsProcessing(false);
                    }
                }, 100);
            };

            const downloadImage = () => {
                if (!processedImageSrc) return;
                const link = document.createElement('a');
                link.href = processedImageSrc;
                link.download = `bmd_film_gen5_${fileInfo?.name.split('.')[0] || 'converted'}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen bg-gray-950 text-gray-200 font-sans selection:bg-teal-500/30">
                <div className="max-w-7xl mx-auto p-4 md:p-8">
                    
                    {/* Header */}
                    <header className="mb-8 border-b border-gray-800 pb-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                        <h1 className="text-2xl font-bold text-white flex items-center gap-3">
                            <span className="text-teal-500"><IconActivity /></span>
                            CST: ProRAW to Blackmagic
                        </h1>
                        <p className="mt-1 text-gray-500 text-sm">
                            Rec.709 Linear → BMD Wide Gamut / Film Gen 5
                        </p>
                        </div>
                        <div className="flex items-center gap-2 text-xs bg-gray-900 border border-gray-800 px-3 py-1.5 rounded-full text-gray-400">
                        <span className="w-4 h-4"><IconInfo /></span>
                        <span>Recommended Input: <strong>PNG (Lossless)</strong></span>
                        </div>
                    </div>
                    </header>

                    {/* Error / Warning Banner */}
                    {error && (
                    <div className="mb-6 bg-red-900/20 border border-red-500/50 rounded-lg p-4 flex gap-3 text-red-200 items-start">
                        <span className="w-5 h-5 shrink-0 text-red-500 mt-0.5"><IconAlert /></span>
                        <div className="text-sm font-medium">{error}</div>
                    </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    {/* Input Column */}
                    <div className="flex flex-col gap-4">
                        <div className="bg-gray-900 rounded-xl border border-gray-800 shadow-xl overflow-hidden flex flex-col h-[500px]">
                        <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                            <h2 className="font-semibold text-gray-300 flex items-center gap-2">
                            <span className="w-4 h-4"><IconUpload /></span> Source Image
                            </h2>
                            {fileInfo && <span className="text-xs font-mono text-gray-500">{fileInfo.name} ({fileInfo.size})</span>}
                        </div>
                        
                        <div className="flex-grow relative bg-gray-950 flex items-center justify-center p-4">
                            {!imageSrc ? (
                            <label className="cursor-pointer flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-700 rounded-lg hover:border-teal-500/50 hover:bg-gray-800/30 transition-all group">
                                <div className="bg-gray-800 p-4 rounded-full mb-3 group-hover:scale-110 transition-transform">
                                    <div className="w-6 h-6 text-teal-500"><IconUpload /></div>
                                </div>
                                <span className="text-teal-400 font-medium">Upload Image</span>
                                <span className="text-xs text-gray-500 mt-2">PNG (Recommended), JPG</span>
                                <span className="text-[10px] text-red-400/70 mt-1">※ TIFF may not work in Chrome</span>
                                <input type="file" accept="image/*,.heic,.tif,.tiff" onChange={handleImageUpload} className="hidden" />
                            </label>
                            ) : (
                            <>
                                <img src={imageSrc} alt="Input" className="max-w-full max-h-full object-contain shadow-2xl" />
                                <button 
                                onClick={() => { setImageSrc(null); setProcessedImageSrc(null); setError(null); setFileInfo(null); }}
                                className="absolute top-4 right-4 bg-gray-900/80 text-white p-2 rounded-lg hover:bg-red-500/80 transition-colors backdrop-blur-sm"
                                >
                                <span className="w-4 h-4"><IconRefresh /></span>
                                </button>
                                <div className="absolute bottom-4 left-4 bg-black/60 backdrop-blur-md text-xs text-white px-2 py-1 rounded font-mono border border-white/10">
                                    {resolution.width} x {resolution.height} px
                                </div>
                            </>
                            )}
                        </div>
                        </div>

                        <button
                        onClick={processImage}
                        disabled={!imageSrc || isProcessing}
                        className={`w-full py-4 rounded-xl font-bold text-lg transition-all shadow-lg flex items-center justify-center gap-3 border
                            ${!imageSrc 
                                ? 'bg-gray-900 text-gray-600 border-gray-800 cursor-not-allowed'
                                : isProcessing
                                    ? 'bg-gray-800 text-teal-500 border-teal-900 cursor-wait'
                                    : 'bg-teal-600 hover:bg-teal-500 text-white border-teal-500 hover:shadow-teal-900/20 active:scale-[0.99]'
                            }`}
                        >
                        {isProcessing ? (
                            <>
                                <span className="w-5 h-5 animate-spin"><IconRefresh /></span>
                                Processing Pipeline...
                            </>
                        ) : (
                            <>
                                <span className="w-5 h-5"><IconActivity /></span>
                                Apply Gen 5 Film Log
                            </>
                        )}
                        </button>
                    </div>

                    {/* Output Column */}
                    <div className="flex flex-col gap-4">
                        <div className="bg-gray-900 rounded-xl border border-gray-800 shadow-xl overflow-hidden flex flex-col h-[500px]">
                        <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50">
                            <h2 className="font-semibold text-teal-400 flex items-center gap-2">
                            <span className="w-4 h-4"><IconActivity /></span> Processed Output
                            </h2>
                            {processedImageSrc && <span className="text-xs text-teal-500 font-medium px-2 py-0.5 bg-teal-900/30 rounded">BMD Film Gen 5</span>}
                        </div>
                        
                        <div className="flex-grow bg-gray-950 flex items-center justify-center p-4 relative">
                            {processedImageSrc ? (
                            <img src={processedImageSrc} alt="Processed" className="max-w-full max-h-full object-contain shadow-2xl" />
                            ) : (
                            <div className="text-gray-700 flex flex-col items-center select-none">
                                <span className="w-12 h-12 mb-3 opacity-20"><IconFileWarning /></span>
                                <p className="text-sm font-medium">No Output Generated</p>
                                <p className="text-xs opacity-60">Upload and process an image to see results</p>
                            </div>
                            )}
                        </div>
                        </div>

                        <button
                            onClick={downloadImage}
                            disabled={!processedImageSrc}
                            className={`w-full py-4 rounded-xl font-bold text-lg transition-all shadow-lg flex items-center justify-center gap-2 border
                            ${!processedImageSrc 
                                ? 'bg-gray-900 text-gray-700 border-gray-800 cursor-not-allowed' 
                                : 'bg-gray-800 hover:bg-gray-700 text-white border-gray-600'
                            }`}
                        >
                            <span className="w-5 h-5"><IconDownload /></span> Save Result (PNG)
                        </button>
                    </div>
                    </div>

                    <div className="mt-8 p-4 rounded-lg bg-gray-900/50 border border-gray-800 text-xs text-gray-500 font-mono">
                        <p className="mb-2 font-bold text-gray-400">[DEBUG INFO]</p>
                        <p>User Agent: {navigator.userAgent}</p>
                        <p>Canvas Support: {!!document.createElement('canvas').getContext ? 'Yes' : 'No'}</p>
                        <p>Last Error: {error || 'None'}</p>
                    </div>

                </div>
                <canvas ref={hiddenCanvasRef} className="hidden" />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

